import streamlit as st
import sqlite3
import pandas as pd
import datetime

st.set_page_config(page_title="Carnivale Feedback System", layout="wide")

# ---------------- DATABASE ----------------
conn = sqlite3.connect("data.db", check_same_thread=False)
c = conn.cursor()

c.execute("""CREATE TABLE IF NOT EXISTS admins(
id INTEGER PRIMARY KEY AUTOINCREMENT,
username TEXT,
password TEXT)""")

c.execute("""CREATE TABLE IF NOT EXISTS staff(
id INTEGER PRIMARY KEY AUTOINCREMENT,
username TEXT,
password TEXT,
branch TEXT)""")

c.execute("""CREATE TABLE IF NOT EXISTS guests(
id INTEGER PRIMARY KEY AUTOINCREMENT,
name TEXT,
mobile TEXT,
branch TEXT,
staff TEXT,
category TEXT,
date TEXT)""")

c.execute("""CREATE TABLE IF NOT EXISTS feedback(
id INTEGER PRIMARY KEY AUTOINCREMENT,
guest_name TEXT,
mobile TEXT,
branch TEXT,
food INTEGER,
service INTEGER,
behaviour INTEGER,
cleanliness INTEGER,
ambience INTEGER,
overall INTEGER,
nps INTEGER,
comment TEXT,
date TEXT)""")

conn.commit()

# Default Admin
if not c.execute("SELECT * FROM admins").fetchall():
    c.execute("INSERT INTO admins (username,password) VALUES (?,?)",("admin","admin123"))
    conn.commit()

# ---------------- AUTO BASE URL ----------------
BASE_URL = st.query_params.get("_base_url", "")
if BASE_URL == "":
    BASE_URL = st.runtime.get_url()

# ---------------- LOGIN SYSTEM ----------------
if "role" not in st.session_state:
    st.session_state.role = None

if st.session_state.role is None:

    st.title("üîê Login Panel")

    role = st.selectbox("Login As", ["Admin", "Staff"])
    user = st.text_input("Username")
    pw = st.text_input("Password", type="password")

    if st.button("Login"):

        if role == "Admin":
            data = c.execute("SELECT * FROM admins WHERE username=? AND password=?", (user, pw)).fetchone()
            if data:
                st.session_state.role = "admin"
                st.rerun()

        if role == "Staff":
            data = c.execute("SELECT * FROM staff WHERE username=? AND password=?", (user, pw)).fetchone()
            if data:
                st.session_state.role = "staff"
                st.session_state.staff = user
                st.session_state.branch = data[3]
                st.rerun()

    st.stop()

# Logout
if st.sidebar.button("Logout"):
    st.session_state.role = None
    st.rerun()

# =====================================================
# ================= ADMIN DASHBOARD ===================
# =====================================================

if st.session_state.role == "admin":

    st.title("üëë Admin Dashboard")

    today = str(datetime.date.today())

    # TODAY BOOKINGS
    st.subheader("üìÖ Today Bookings")

    today_data = pd.read_sql_query("""
    SELECT name, mobile, category, branch, staff
    FROM guests
    WHERE date = ?
    """, conn, params=(today,))

    st.dataframe(today_data)

    # CATEGORY SUMMARY
    st.subheader("üìä Booking Category Summary")

    cat = pd.read_sql_query("""
    SELECT category, COUNT(*) as total_bookings
    FROM guests
    GROUP BY category
    """, conn)

    st.dataframe(cat)

    # REPEAT GUESTS
    st.subheader("üîÅ Repeat Guests")

    repeat = pd.read_sql_query("""
    SELECT name, mobile, COUNT(*) as visits
    FROM guests
    GROUP BY mobile
    HAVING visits > 1
    """, conn)

    st.dataframe(repeat)

    # FEEDBACK LIST
    st.subheader("üìù Feedback List")

    fb = pd.read_sql_query("""
    SELECT guest_name, mobile, branch, overall, nps, date
    FROM feedback
    ORDER BY date DESC
    """, conn)

    st.dataframe(fb)

# =====================================================
# ================= STAFF DASHBOARD ===================
# =====================================================

if st.session_state.role == "staff":

    st.title("üë®‚Äçüíº Staff Panel")

    with st.form("guest_form", clear_on_submit=True):

        name = st.text_input("Guest Name")
        mobile = st.text_input("Mobile Number")

        category = st.selectbox(
            "Booking Category",
            ["Party", "Zomato", "VIP", "Easy Dinner", "Corporate", "Walk-in"]
        )

        booking_date = st.date_input("Booking Date", datetime.date.today())

        submit = st.form_submit_button("Add Guest")

        if submit:
            c.execute("""
            INSERT INTO guests (name,mobile,branch,staff,category,date)
            VALUES (?,?,?,?,?,?)
            """,
            (name, mobile,
             st.session_state.branch,
             st.session_state.staff,
             category,
             str(booking_date)))

            conn.commit()

            link = f"{BASE_URL}?feedback={mobile}&branch={st.session_state.branch}"

            whatsapp = f"https://wa.me/{mobile}?text=Thank you for visiting Carnivale ‚ù§Ô∏è Please give feedback {link}"

            st.success("Guest Added Successfully")
            st.markdown(f"[üì≤ Send WhatsApp Feedback]({whatsapp})")

    # STAFF DAILY DATA
    st.subheader("üìã Today's Entries")

    staff_data = pd.read_sql_query("""
    SELECT name, mobile, category, date
    FROM guests
    WHERE staff = ?
    """, conn, params=(st.session_state.staff,))

    st.dataframe(staff_data)

    csv = staff_data.to_csv(index=False).encode()
    st.download_button("Download Excel", csv, "staff_data.csv", "text/csv")

# =====================================================
# ================= FEEDBACK PAGE =====================
# =====================================================

query = st.query_params

if "feedback" in query:

    mobile = query["feedback"]
    branch = query.get("branch", "Main")

    st.title("üçΩ Carnivale Restaurant Feedback")

    guest_data = pd.read_sql_query(
        "SELECT name FROM guests WHERE mobile=? ORDER BY date DESC LIMIT 1",
        conn, params=(mobile,)
    )

    guest_name = guest_data.iloc[0]["name"] if not guest_data.empty else ""

    st.write("Guest:", guest_name)
    st.write("Branch:", branch)

    with st.form("feedback_form"):

        food = st.slider("Food Quality ‚≠ê", 1, 5, 4)
        service = st.slider("Service ‚≠ê", 1, 5, 4)
        behaviour = st.slider("Staff Behaviour ‚≠ê", 1, 5, 4)
        cleanliness = st.slider("Cleanliness ‚≠ê", 1, 5, 4)
        ambience = st.slider("Ambience ‚≠ê", 1, 5, 4)
        overall = st.slider("Overall Experience ‚≠ê", 1, 5, 4)

        nps = st.slider("Recommend us? (0-10)", 0, 10, 8)
        comment = st.text_area("Additional Comments")

        submit = st.form_submit_button("Submit Feedback")

        if submit:
            c.execute("""
            INSERT INTO feedback
            (guest_name,mobile,branch,
            food,service,behaviour,
            cleanliness,ambience,overall,
            nps,comment,date)
            VALUES (?,?,?,?,?,?,?,?,?,?,?,?)
            """,
            (guest_name,mobile,branch,
             food,service,behaviour,
             cleanliness,ambience,overall,
             nps,comment,
             str(datetime.date.today())))

            conn.commit()

            st.success("Thank You ‚ù§Ô∏è")
            st.balloons()

    st.stop()
